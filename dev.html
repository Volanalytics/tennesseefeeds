<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennessee News | Latest Tennessee Headlines | TennesseeFeeds.com</title>
    <meta name="description" content="Real-time Tennessee news aggregation. Stay informed with the latest headlines from Nashville, Memphis, Knoxville, Chattanooga, and across Tennessee.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="TennesseeFeeds">
    <meta property="og:url" content="https://tennesseefeeds.com/">
    <meta property="og:title" content="Tennessee News | Latest Headlines | TennesseeFeeds">
    <meta property="og:description" content="Real-time Tennessee news aggregation. Stay informed with the latest headlines from across Tennessee.">
    <meta property="og:image" content="https://tennesseefeeds.com/social-share.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://tennesseefeeds.com/">
    <meta name="twitter:title" content="Tennessee News | Latest Headlines | TennesseeFeeds">
    <meta name="twitter:description" content="Real-time Tennessee news aggregation from Nashville, Memphis, Knoxville, Chattanooga, and beyond.">
    <meta name="twitter:image" content="https://tennesseefeeds.com/social-share.jpg">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui']
                    },
                    spacing: {
                        '128': '32rem',
                    }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Replace the existing Fingerprint2 script with this -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.4/fingerprint2.min.js"></script>
    
    <!-- User tracking system -->
    <script src="user-tracking.js"></script>
    
    <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Line clamp for description */
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;  
        overflow: hidden;
    }
    
    /* Modal styles */
    #share-modal.hidden {
        display: none;
    }
    
    #share-url {
        background-color: #f5f5f5;
    }

    /* Ensure comments-section stays visible and is not affected by layout shifts */
    .comments-section {
        position: relative;
        display: none; /* Initial state */
    }
    .comments-section[style*="display: block"] {
        display: block !important;
        visibility: visible !important;
        position: relative;
        z-index: 1;
    }
    
    /* Dropdown menu styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        min-width: 200px;
        background-color: white;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        border-radius: 6px;
        z-index: 20;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .dropdown-content.show {
        display: block;
    }
    
    .dropdown-menu-item {
        display: block;
        width: 100%;
        text-align: left;
        padding: 10px 15px;
        color: #333;
        transition: background-color 0.2s;
    }
    
    .dropdown-menu-item:hover {
        background-color: #f5f5f5;
    }
    
    /* Improved mobile menu styles - with animation */
    .mobile-menu {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 50;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .mobile-menu.show {
        display: block;
        opacity: 1;
    }
    
    .mobile-menu-content {
        position: absolute;
        top: 0;
        right: 0;
        width: 80%;
        max-width: 300px;
        height: 100%;
        background-color: #333;
        padding: 20px;
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }
    
    .mobile-menu.show .mobile-menu-content {
        transform: translateX(0);
    }
    
    /* Improved article card styles */
    .article-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .article-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    /* Format ISO dates in a more readable way */
    .formatted-date {
        display: inline-block;
    }

    /* Single article view styles */
    #single-article-view {
        display: none;
    }

    #single-article-view.show {
        display: block;
    }

    /* Article loading overlay */
    #article-loading-overlay {
        display: none;
    }

    #article-loading-overlay.show {
        display: flex;
    }
    
    /* Search result styles */
    .search-result-item {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .search-result-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    /* Search overlay animation */
    #search-overlay {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    #search-overlay:not(.hidden) {
        opacity: 1;
    }
    
    #search-overlay > div {
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    
    #search-overlay:not(.hidden) > div {
        transform: translateY(0);
    }
    
    /* Improved focus states for accessibility */
    a:focus,
    button:focus,
    input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    
    /* Improved active menu item indication */
    .region-link.active,
    .category-link.active {
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 600;
    }
</style>
</head>
<body class="bg-neutral-50 text-neutral-900">
   <!-- Header -->
<!-- Desktop Header (hidden on mobile) -->
<header class="bg-neutral-800 text-white py-3 shadow-md hidden md:block">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between">
            <!-- Left side: Logo and brand -->
            <div class="flex items-center">
                <i class="fas fa-newspaper text-2xl mr-3"></i>
                <div>
                    <h1 class="text-xl font-bold">TennesseeFeeds</h1>
                    <p class="text-xs text-neutral-300">Your Local News Pulse</p>
                </div>
            </div>

            <!-- Center: Search bar -->
            <div class="mx-4 flex-grow max-w-md">
                <div class="relative">
                    <input 
                        type="search" 
                        id="search-input" 
                        placeholder="Search articles..." 
                        class="w-full px-4 py-1 pr-10 rounded-md text-neutral-800"
                    >
                    <button 
                        id="search-button" 
                        class="absolute right-0 top-0 h-full px-3 text-neutral-600 hover:text-neutral-800"
                    >
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Right side: Navigation -->
            <div class="flex items-center space-x-1">
                <!-- Main navigation links -->
                <nav class="flex items-center">
                    <a href="#" class="region-link px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors" data-region="all">All Tennessee</a>
                    <a href="#" class="region-link px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors" data-region="nashville">Nashville</a>
                    <a href="#" class="region-link px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors" data-region="memphis">Memphis</a>
                    <a href="#" class="region-link px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors" data-region="knoxville">Knoxville</a>
                    <a href="#" class="region-link px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors" data-region="chattanooga">Chattanooga</a>
                    
                    <!-- Dropdowns -->
                    <div class="flex items-center ml-2">
                        <!-- More Regions Dropdown - keeping original IDs for script compatibility -->
                        <div class="dropdown px-1">
                            <button id="more-regions-toggle" class="px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors flex items-center">
                                More Regions
                                <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>
                            <div id="more-regions-menu" class="dropdown-content">
                                <a href="#" class="dropdown-menu-item region-link" data-region="tri-cities">Tri-Cities</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="jackson">Jackson</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="clarksville">Clarksville</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="murfreesboro">Murfreesboro</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="maryville">Maryville</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="cleveland">Cleveland</a>
                                <a href="#" class="dropdown-menu-item region-link" data-region="cookeville">Cookeville</a>
                            </div>
                        </div>
                        
                        <!-- Categories Dropdown - keeping original IDs for script compatibility -->
                        <div class="dropdown px-1">
                            <button id="categories-toggle" class="px-3 py-2 rounded-md hover:bg-neutral-700 transition-colors flex items-center">
                                Categories
                                <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>
                            <div id="categories-menu" class="dropdown-content">
                                <a href="#" class="dropdown-menu-item category-link" data-category="news">News</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="general">General</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="entertainment">Entertainment</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="business">Business</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="education">Education</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="politics">Politics</a>
                                <a href="#" class="dropdown-menu-item category-link" data-category="sports">Sports</a>
                            </div>
                        </div>
                    </div>
                </nav>
                
                <!-- User profile area - keeping original IDs for script compatibility -->
                <div id="user-profile" class="flex items-center ml-4 border-l pl-4 border-neutral-600">
                    <div class="text-right mr-2">
                        <span class="text-xs text-neutral-300">Browsing as:</span>
                        <div id="username-display" class="text-sm font-semibold username-display">Anonymous</div>
                    </div>
                    <button id="change-username-btn" class="text-xs px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 transition-colors">
                        Change
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Filter Status Bar - needed for current functionality -->
        <div class="mt-2 flex flex-wrap items-center text-sm text-neutral-300">
            <div class="flex items-center mr-4">
                <i class="fas fa-map-marker-alt mr-1"></i>
                <span id="current-filter-region">All Tennessee</span>
            </div>
            <div id="category-filter-indicator" class="flex items-center hidden">
                <i class="fas fa-tag mr-1"></i>
                <span id="current-filter-category">Category</span>
            </div>
        </div>
    </div>
</header>

<!-- Improved Mobile Menu (Sliding from right) -->
<div id="mobile-menu" class="mobile-menu">
    <div class="mobile-menu-content">
        <div class="flex justify-between items-center mb-4 text-white">
            <h3 class="text-lg font-bold">Menu</h3>
            <button id="close-mobile-menu" class="text-white text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Mobile Search -->
        <div class="mb-4 relative">
            <input 
                type="search" 
                id="mobile-search-input" 
                placeholder="Search articles..." 
                class="w-full px-4 py-2 pr-10 rounded-md text-neutral-800"
            >
            <button 
                id="mobile-search-button" 
                class="absolute right-0 top-0 h-full px-3 text-neutral-600 hover:text-neutral-800"
            >
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <!-- Mobile Region Links -->
        <div class="mb-6">
            <h4 class="text-white text-sm font-semibold mb-2 pb-1 border-b border-neutral-600">Regions</h4>
            <div class="space-y-1">
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="all">All Tennessee</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="nashville">Nashville</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="memphis">Memphis</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="knoxville">Knoxville</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="chattanooga">Chattanooga</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="tri-cities">Tri-Cities</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="jackson">Jackson</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="clarksville">Clarksville</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="murfreesboro">Murfreesboro</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="maryville">Maryville</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="cleveland">Cleveland</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors region-link" data-region="cookeville">Cookeville</a>
            </div>
        </div>
        
        <!-- Mobile Category Links -->
        <div class="mb-6">
            <h4 class="text-white text-sm font-semibold mb-2 pb-1 border-b border-neutral-600">Categories</h4>
            <div class="space-y-1">
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="news">News</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="general">General</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="entertainment">Entertainment</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="business">Business</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="education">Education</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="politics">Politics</a>
                <a href="#" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors category-link" data-category="sports">Sports</a>
            </div>
        </div>
        
        <!-- Mobile Saved Articles Quick Access -->
        <div class="mb-6">
            <h4 class="text-white text-sm font-semibold mb-2 pb-1 border-b border-neutral-600">Your Saved Articles</h4>
            <a href="#pinned-articles" class="block py-2 px-3 rounded text-white hover:bg-neutral-700 transition-colors">
                <i class="fas fa-bookmark mr-2"></i>View Saved Articles
            </a>
        </div>
        
        <!-- Mobile User Profile-->
        <div class="mt-auto">
            <div class="text-white py-3 px-3 border-t border-neutral-600">
                <div class="text-xs text-neutral-400">Browsing as:</div>
                <div class="flex justify-between items-center mt-1">
                    <span class="text-sm font-semibold mobile-username-display">Anonymous</span>
                    <button id="mobile-change-username-btn" class="text-xs px-2 py-1 rounded bg-neutral-700 hover:bg-neutral-600 transition-colors">Change</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Results Overlay -->
<div id="search-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start overflow-y-auto pt-20 pb-20">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-neutral-800">
                Search Results for "<span id="search-term"></span>"
            </h3>
            <button id="close-search-button" class="text-neutral-500 hover:text-neutral-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="search-results" class="max-h-full overflow-y-auto">
            <!-- Search results will be populated here -->
        </div>
    </div>
</div>

<!-- Main Content -->
<main class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-neutral-800">Latest Tennessee News</h2>
        <button id="refresh-btn" class="bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600 transition-colors flex items-center">
            <i class="fas fa-sync mr-2"></i>
            Refresh
        </button>
    </div>

    <div id="status-bar" class="bg-neutral-100 p-3 rounded-md mb-4 flex justify-between items-center">
        <span id="status" class="text-neutral-700">Loading latest news...</span>
        <div class="flex items-center">
            <span id="filter-info" class="text-neutral-600 mr-3">Region: <span id="current-region">All Tennessee</span></span>
            <span id="page-info" class="text-neutral-600">Page: <span id="current-page">1</span></span>
        </div>
    </div>

    <div id="loading" class="hidden text-center py-12">
        <div class="animate-spin mx-auto h-12 w-12 border-4 border-neutral-300 border-t-neutral-600 rounded-full"></div>
        <p class="mt-4 text-neutral-600">Loading Tennessee news...</p>
    </div>
    
    <!-- Grid layout with sidebar -->
    <div class="grid md:grid-cols-4 gap-8">
        <!-- Sidebar (for recently shared articles and trending contributors) -->
        <div class="md:col-span-1">
            <!-- Recently Shared Articles -->
            <div class="shared-articles bg-white rounded-lg shadow-md overflow-hidden p-4 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-neutral-800">
                        <i class="fas fa-share-alt text-blue-500 mr-2"></i>Recently Shared
                    </h3>
                    <span class="text-xs text-neutral-500">Articles shared by users</span>
                </div>
                
                <div class="shared-articles-list">
                    <!-- Will be populated by article-system.js -->
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin h-5 w-5 border-2 border-neutral-300 border-t-neutral-600 rounded-full"></div>
                        <p class="text-sm text-neutral-500 mt-2">Loading shared articles...</p>
                    </div>
                </div>
            </div>
           
            <!-- Trending Contributors - Already included via trending-contributors.js -->
        </div>
        
        <!-- Main content area -->
        <div class="md:col-span-3">
            <!-- PINNED SAVED ARTICLES SECTION -->
            <div id="pinned-articles" class="mb-8">
                <div class="flex justify-between items-center mb-4 p-2 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-semibold text-blue-800">
                        <i class="fas fa-bookmark mr-2"></i>Saved Articles
                    </h3>
                    <span class="text-sm text-blue-600">0 saved</span>
                </div>
                
                <div id="pinned-articles-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Will be populated by article-system.js -->
                    <div class="col-span-full text-center py-8">
                        <p class="text-neutral-500">You haven't saved any articles yet.</p>
                        <p class="text-sm text-neutral-500 mt-2">Click the bookmark icon on any article to save it here.</p>
                    </div>
                </div>
            </div>
            
            <!-- Regular articles -->
            <div id="content-area" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Articles will appear here -->
            </div>
            
            <!-- Load More Button -->
            <div class="text-center mt-8">
                <button id="load-more-btn" class="bg-neutral-700 text-white px-6 py-3 rounded-md hover:bg-neutral-600 transition-colors">
                    Load More Articles
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-neutral-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
        <p>Â© 2024 TennesseeFeeds. All Rights Reserved.</p>
        <div class="mt-4 space-x-4">
            <a href="https://tennesseefeeds.com/index.html" class="hover:text-neutral-300">Home</a>
            <a href="https://tennesseefeeds.com/privacy-policy.html" class="hover:text-neutral-300">Privacy Policy</a>
            <a href="https://tennesseefeeds.com/TOS.html" class="hover:text-neutral-300">Terms of Service</a>
            <a href="https://tennesseefeeds.com/how-it-works.html" class="hover:text-neutral-300">How It Works</a>
            <a href="#" class="hover:text-neutral-300">Contact</a>
        </div>
    </div>
</footer>

<script>
// Unified URL parameter handling
function handleUrlParameters() {
    // Check for article parameter
    const urlParams = new URLSearchParams(window.location.search);
    const articleUrl = urlParams.get('article');
    
    if (articleUrl) {
        console.log('Found article URL in parameters:', articleUrl);
        try {
            // Check if it's a valid URL first
            if (articleUrl === '#' || articleUrl === 'undefined' || !articleUrl.includes('://')) {
                console.warn('Invalid article URL detected:', articleUrl);
                return false;
            }
            
            // Redirect to the article URL if it's valid
            window.location.href = decodeURIComponent(articleUrl);
            return true;
        } catch (e) {
            console.error('Error handling article parameter:', e);
            return false;
        }
    }
    
    // Check for share redirect
    const pathname = window.location.pathname;
    if (pathname.startsWith('/share/')) {
        let articleId;
if (article.link.includes('/article_')) {
    // Extract just the article ID for URLs containing article_ pattern
    articleId = 'article-' + article.link.split('/article_')[1].replace('.html', '').replace(/[^a-zA-Z0-9-]/g, '-');
} else {
    // Create a hash for other URLs
    articleId = 'article-' + Math.abs(article.title.split('').reduce((acc, char) => {
        return acc + char.charCodeAt(0);
    }, 0) % 100000).toString();
}
        const shareParams = new URLSearchParams(window.location.search);
        const shareArticleUrl = shareParams.get('article');
        
        if (shareArticleUrl) {
            window.location.href = decodeURIComponent(shareArticleUrl);
            return true;
        }
    }
    
    // Check for hash article
    if (window.location.hash && window.location.hash.includes('article=')) {
        try {
            const hashArticleUrl = decodeURIComponent(window.location.hash.split('article=')[1]);
            if (hashArticleUrl && hashArticleUrl.startsWith('http')) {
                window.location.href = hashArticleUrl;
                return true;
            }
        } catch (e) {
            console.error('Error handling hash article:', e);
        }
    }
    
    return false;
}

// Wait for the document to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Handle URL parameters first
    if (!handleUrlParameters()) {
        // Mobile menu functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const closeMobileMenu = document.getElementById('close-mobile-menu');
        const mobileMenu = document.getElementById('mobile-menu');

        if (mobileMenuToggle && mobileMenu) {
            mobileMenuToggle.addEventListener('click', function() {
                mobileMenu.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
            });
        }

        if (closeMobileMenu && mobileMenu) {
            closeMobileMenu.addEventListener('click', function() {
                mobileMenu.classList.remove('show');
                document.body.style.overflow = '';
            });
            
            // Also close when clicking outside the menu content
            mobileMenu.addEventListener('click', function(e) {
                if (e.target === mobileMenu) {
                    mobileMenu.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        }

        // Desktop dropdowns functionality
        const moreRegionsToggle = document.getElementById('more-regions-toggle');
        const moreRegionsMenu = document.getElementById('more-regions-menu');
        const categoriesToggle = document.getElementById('categories-toggle');
        const categoriesMenu = document.getElementById('categories-menu');

        // Function to toggle dropdown visibility
        function toggleDropdown(menu) {
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                if (dropdown !== menu) {
                    dropdown.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        if (moreRegionsToggle && moreRegionsMenu) {
            moreRegionsToggle.addEventListener('click', function(e) {
                e.preventDefault();
                toggleDropdown(moreRegionsMenu);
            });
        }

        if (categoriesToggle && categoriesMenu) {
            categoriesToggle.addEventListener('click', function(e) {
                e.preventDefault();
                toggleDropdown(categoriesMenu);
            });
        }

        // Close dropdowns when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Mobile username change
        const mobileChangeUsernameBtn = document.getElementById('mobile-change-username-btn');
        if (mobileChangeUsernameBtn) {
            mobileChangeUsernameBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (window.updateUsername) {
                    window.updateUsername().then(() => {
                        // Update mobile username display after change
                        const mobileUsernameDisplay = document.querySelector('.mobile-username-display');
                        const storedUsername = localStorage.getItem('tnfeeds_username') || 'Anonymous';
                        if (mobileUsernameDisplay) {
                            mobileUsernameDisplay.textContent = storedUsername;
                        }
                    });
                }
            });
        }

        // Initialize mobile username display
        const mobileUsernameDisplay = document.querySelector('.mobile-username-display');
        if (mobileUsernameDisplay) {
            const storedUsername = localStorage.getItem('tnfeeds_username') || 'Anonymous';
            mobileUsernameDisplay.textContent = storedUsername;
        }

        // Category filtering functionality
        let currentCategory = null;
        const categoryLinks = document.querySelectorAll('.category-link');
        const categoryInfoElement = document.getElementById('category-info');
        const currentCategoryElement = document.getElementById('current-category');
        const categoryFilterIndicator = document.getElementById('category-filter-indicator');
        const currentFilterCategory = document.getElementById('current-filter-category');

        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const category = this.dataset.category;
                filterArticlesByCategory(category);
                
                // Update UI to show active category
                categoryLinks.forEach(catLink => {
                    catLink.classList.remove('bg-neutral-700');
                });
                document.querySelectorAll(`.category-link[data-category="${category}"]`).forEach(catLink => {
                    catLink.classList.add('bg-neutral-700');
                });
                
                // Close mobile menu if open
                if (mobileMenu) {
                    mobileMenu.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });

        // Improved category filtering function
function filterArticlesByCategory(category) {
    currentCategory = category;
    currentPage = 1;
    displayedArticlesCount = 0;
    
    // Update UI elements
    if (currentCategoryElement) {
        currentCategoryElement.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categoryInfoElement?.classList.remove('hidden');
    }
    
    if (currentFilterCategory) {
        currentFilterCategory.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categoryFilterIndicator.classList.remove('hidden');
    }
    
    // Clear the content area
    contentArea.innerHTML = '';
    
    // More flexible category matching
    const categoryLower = category.toLowerCase().trim();
    
    // Filter articles with a more flexible approach
    filteredArticles = allArticles.filter(article => {
        // Check if article has category
        if (!article.category) return false;
        
        // Convert article category to lowercase for comparison
        const articleCategory = article.category.toLowerCase().trim();
        
        // Check for exact match
        if (articleCategory === categoryLower) return true;
        
        // Check if category is included in article category (for multi-category articles)
        if (articleCategory.includes(categoryLower)) return true;
        
        // Check for common variations (singular/plural)
        if (categoryLower.endsWith('s') && articleCategory === categoryLower.slice(0, -1)) return true;
        if (articleCategory.endsWith('s') && categoryLower === articleCategory.slice(0, -1)) return true;
        
        // Add synonym matching for common categories
        const synonyms = {
            'news': ['general', 'latest', 'headlines', 'updates'],
            'sports': ['athletic', 'game', 'match', 'tournament'],
            'entertainment': ['arts', 'culture', 'leisure', 'events'],
            'business': ['finance', 'economy', 'commerce', 'market'],
            'politics': ['government', 'policy', 'election', 'legislative'],
            'education': ['school', 'academic', 'learning', 'teaching'],
            'technology': ['tech', 'digital', 'innovation', 'science']
        };
        
        // Check for synonyms
        if (synonyms[categoryLower] && synonyms[categoryLower].includes(articleCategory)) return true;
        
        // No match found
        return false;
    });
    
    // Also check title and description for category keywords
    if (filteredArticles.length < 3) {
        // If we don't have many articles, try a more aggressive approach
        const additionalArticles = allArticles.filter(article => {
            // Skip articles already included
            if (filteredArticles.includes(article)) return false;
            
            // Check title and description for category term
            const title = article.title ? article.title.toLowerCase() : '';
            const description = article.description ? article.description.toLowerCase() : '';
            
            return title.includes(categoryLower) || description.includes(categoryLower);
        });
        
        // Add these to our filtered articles
        filteredArticles = [...filteredArticles, ...additionalArticles];
    }
    
    statusElement.textContent = `Showing ${filteredArticles.length} ${category} articles for ${currentRegionElement.textContent}`;
    displayArticles();
}

        // Configuration
        const apiUrl = 'https://tennesseefeeds-api.onrender.com/api/feeds';
        const statusElement = document.getElementById('status');
        const loadingElement = document.getElementById('loading');
        const contentArea = document.getElementById('content-area');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const currentPageElement = document.getElementById('current-page');
        const currentRegionElement = document.getElementById('current-region');
        
        // Setup username display
        const usernameDisplay = document.getElementById('username-display');
        const userProfile = document.getElementById('user-profile');
        const changeUsernameBtn = document.getElementById('change-username-btn');
        
        if (usernameDisplay && userProfile && window.UserTracking) {
            // Get the user profile
            window.UserTracking.getUserProfile().then(user => {
                if (user) {
                    usernameDisplay.textContent = user.username;
                    userProfile.classList.remove('hidden');
                }
            });
            
            // Add change username functionality
            changeUsernameBtn.addEventListener('click', async function() {
                if (window.updateUsername) {
                    await window.updateUsername();
                    // Refresh the user profile
                    const updatedUser = await window.UserTracking.getUserProfile();
                    if (updatedUser) {
                        usernameDisplay.textContent = updatedUser.username;
                    }
                }
            });
        }
        
        // Pagination and filtering settings
        let currentPage = 1;
        let currentRegion = 'all';
        const articlesPerPage = 6;
        let allArticles = [];
        let filteredArticles = [];
        let displayedArticlesCount = 0;
        
        // Format dates helper function
        function formatISODate(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return isoString;
            }
        }
        
        // Function to handle API errors gracefully
        function handleApiError(error) {
            console.error('Error fetching articles:', error);
            loadingElement.classList.add('hidden');
            statusElement.textContent = 'Error loading articles';
            contentArea.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <p class="text-red-600 mb-4">Error: ${error.message || 'Failed to fetch data'}. Please try again later.</p>
                    <button id="retry-btn" class="bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600 transition-colors">
                        <i class="fas fa-sync mr-2"></i>Retry
                    </button>
                </div>
            `;
            
            document.getElementById('retry-btn').addEventListener('click', function() {
                fetchArticles(true);
            });
        }
        
        // Function to filter articles by region
        function filterArticlesByRegion(region) {
            currentRegion = region;
            currentPage = 1;
            displayedArticlesCount = 0;
            
            document.querySelectorAll('.region-link').forEach(link => {
                if (link.dataset.region === region) {
                    link.classList.add('bg-neutral-700');
                } else {
                    link.classList.remove('bg-neutral-700');
                }
            });
            
            currentRegionElement.textContent = region === 'all' ? 'All Tennessee' : 
                region.charAt(0).toUpperCase() + region.slice(1);
            
            contentArea.innerHTML = '';
            
            if (region === 'all') {
                filteredArticles = [...allArticles];
            } else {
                const regionLower = region.toLowerCase();
                filteredArticles = allArticles.filter(article => {
                    const title = article.title ? article.title.toLowerCase() : '';
                    const description = article.description ? article.description.toLowerCase() : '';
                    const source = article.source ? article.source.toLowerCase() : '';
                    return title.includes(regionLower) || description.includes(regionLower) || source.includes(regionLower);
                });
            }
            
            statusElement.textContent = `Showing ${filteredArticles.length} articles for ${currentRegionElement.textContent}`;
            displayArticles();
        }
        
        // Function to create article URL for comment links
        function createArticleUrl(articleId, title) {
            const baseUrl = window.location.href.split('?')[0]; // Remove existing query params
            const titleParam = title ? '&title=' + encodeURIComponent(title) : '';
            return `${baseUrl}?article=${articleId}${titleParam}`;
        }
        
        // Function to display articles for the current page
        function displayArticles() {
            console.log('Rendering articles, displayed count:', displayedArticlesCount);
            const startIndex = displayedArticlesCount;
            const endIndex = startIndex + articlesPerPage;
            const articlesToDisplay = filteredArticles.slice(startIndex, endIndex);
            
            if (articlesToDisplay.length === 0) {
                if (displayedArticlesCount === 0) {
                    contentArea.innerHTML = '<p class="text-neutral-600 text-center col-span-full my-8">No articles found for this region. Try another region or refresh the page.</p>';
                }
                loadMoreBtn.textContent = 'No More Articles';
                loadMoreBtn.disabled = true;
                return;
            }
            
            articlesToDisplay.forEach((article) => {
                const articleElement = document.createElement('div');
                articleElement.className = 'article-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow mb-8';
                
                const articleId = article.link.replace(/[^a-zA-Z0-9]/g, '-');
                
                let image = '';
                if (article.image) {
                    image = `<img src="${article.image}" alt="${article.title}" class="w-full h-48 object-cover">`;
                }
                
                // Format date
                const formattedDate = formatISODate(article.pubDate);
                
                // Add category badge if available
                let categoryBadge = '';
                if (article.category) {
                    categoryBadge = `<span class="ml-2 px-2 py-0.5 bg-neutral-200 text-neutral-700 rounded-full text-xs">${article.category}</span>`;
                }
                
                articleElement.innerHTML = `
                    ${image}
                    <div class="p-6" data-article-id="${articleId}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="text-sm text-neutral-500">${article.source}</span>
                                ${categoryBadge}
                            </div>
                            <span class="text-sm text-neutral-500 formatted-date">${formattedDate}</span>
                        </div>
                        <h3 class="text-xl font-bold text-neutral-800 mb-3">
                           <a href="${article.link}" target="_blank" class="article-link hover:text-neutral-600 transition-colors" data-article-id="${articleId}">
                                ${article.title}
                            </a>
                        </h3>
                        <p class="text-neutral-600 mb-4 line-clamp-3">${article.description}</p>
                        <div class="flex justify-between items-center border-t pt-4">
                            <div class="flex space-x-4">
                                <button class="like-btn flex items-center text-neutral-600 hover:text-neutral-800" data-article-id="${articleId}" data-action="like">
                                    <i class="fas fa-thumbs-up mr-2"></i>
                                    <span class="like-count">0</span>
                                </button>
                                <button class="dislike-btn flex items-center text-neutral-600 hover:text-neutral-800" data-article-id="${articleId}" data-action="dislike">
                                    <i class="fas fa-thumbs-down mr-2"></i>
                                    <span class="dislike-count">0</span>
                                </button>
                                <a href="${createArticleUrl(articleId, article.title)}" class="comment-link flex items-center text-neutral-600 hover:text-neutral-800">
                                    <i class="fas fa-comment mr-2"></i>
                                    <span>Comment</span>
                                </a>
                                <button class="favorite-btn flex items-center text-neutral-600 hover:text-neutral-800" data-article-id="${articleId}">
                                    <i class="far fa-bookmark mr-2"></i>
                                    <span>Save</span>
                                </button>
                            </div>
                            <button class="share-btn text-neutral-600 hover:text-neutral-800" data-article-id="${articleId}">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                        <div class="comments-section mt-4 border-t pt-4" style="display: none;">
                            <div class="flex mb-4">
                                <input type="text" class="comment-input flex-grow mr-2 px-3 py-2 border rounded-md text-neutral-700" placeholder="Write a comment...">
                                <button class="post-comment-btn bg-neutral-700 text-white px-4 py-2 rounded-md">Post</button>
                            </div>
                            <div class="comments-container max-h-64 overflow-y-auto pr-2" data-comments-container="${articleId}">
                                <p class="text-neutral-500 text-sm">No comments yet.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                contentArea.appendChild(articleElement);
            });
            
            displayedArticlesCount += articlesToDisplay.length;
            
            setupInteractions();
            
            loadMoreBtn.disabled = displayedArticlesCount >= filteredArticles.length;
            if (displayedArticlesCount >= filteredArticles.length) {
                loadMoreBtn.textContent = 'No More Articles';
            }
            
            currentPageElement.textContent = currentPage;
        }

        // Function to remove duplicates based on title
function removeDuplicateArticles(articles) {
  const uniqueArticles = [];
  const titleMap = {};
  
  articles.forEach(article => {
    if (!titleMap[article.title]) {
      titleMap[article.title] = true;
      uniqueArticles.push(article);
    }
  });
  
  console.log(`Removed ${articles.length - uniqueArticles.length} duplicate articles`);
  return uniqueArticles;
}

        
        // Modified fetchArticles function that tries direct API connection
        async function fetchArticles(refresh = false) {
            try {
                // Simple loading indicator
                loadingElement.classList.remove('hidden');
                
                if (refresh) {
                    contentArea.innerHTML = '';
                    currentPage = 1;
                    displayedArticlesCount = 0;
                    currentPageElement.textContent = currentPage;
                }
                
                statusElement.textContent = 'Fetching articles...';
                
                // Try direct API first (might work if CORS is properly configured on server)
                const apiUrl = 'https://tennesseefeeds-api.onrender.com/api/feeds';
                let data = null;
                let success = false;
                
                // First, try direct API call
                try {
                    statusElement.textContent = 'Connecting to API directly...';
                    console.log('Trying direct API connection');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(apiUrl, {
                        signal: controller.signal,
                        method: 'GET',
                        headers: {
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                        },
                        mode: 'cors'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        data = await response.json();
                        success = true;
                    } else {
                        console.log('Direct API connection failed with status:', response.status);
                    }
                } catch (directError) {
                    console.log('Direct API connection failed:', directError.message);
                }
                
                // If direct API fails, try using a locally cached copy
                if (!success) {
                    try {
                        statusElement.textContent = 'Using cached data...';
                        console.log('Trying to use cached data');
                        
                        const cachedData = localStorage.getItem('tennesseefeeds_cache');
                        const cacheTimestamp = localStorage.getItem('tennesseefeeds_cache_timestamp');
                        
                        if (cachedData && cacheTimestamp) {
                            const cacheAge = Date.now() - parseInt(cacheTimestamp);
                            const maxCacheAge = 30 * 60 * 1000; // 30 minutes
                            
                            if (cacheAge < maxCacheAge) {
                                data = JSON.parse(cachedData);
                                statusElement.textContent = `Using cached data (${Math.round(cacheAge / 60000)} min old)`;
                                success = true;
                            } else {
                                console.log('Cache is too old:', Math.round(cacheAge / 60000), 'minutes');
                            }
                        } else {
                            console.log('No cached data found');
                        }
                    } catch (cacheError) {
                        console.log('Error using cached data:', cacheError.message);
                    }
                }
                
                // If we have data (from direct API or cache), process it
                if (success && data) {
                    console.log('Data received:', data);
                    
                    if (!data.articles || !Array.isArray(data.articles) || data.articles.length === 0) {
                        loadingElement.classList.add('hidden');
                        statusElement.textContent = 'No articles found';
                        contentArea.innerHTML = '<p class="text-neutral-600 text-center col-span-full">No articles available at this time.</p>';
                        return false;
                    }
                    
                    // If this was a successful API call, cache the response
                    if (!data._fromCache) {
                        try {
                        localStorage.setItem('tennesseefeeds_cache', JSON.stringify(data));
                        localStorage.setItem('tennesseefeeds_cache_timestamp', Date.now().toString());
                        console.log('Data cached successfully');
                        } catch (cacheError) {
                        console.log('Error caching data:', cacheError.message);
                        }
                    }
                    
                    // Process articles
                    allArticles = data.articles;
                    filteredArticles = [...allArticles];

                          // ADD THE DEDUPLICATION CODE RIGHT HERE
                    allArticles = removeDuplicateArticles(allArticles);
      
                    filteredArticles = [...allArticles];
                    
                    // Set status before rendering (which can take time)
                    statusElement.textContent = `Showing ${filteredArticles.length} articles`;
                    
                    // Make articles available for search
                    window.allArticles = allArticles;
                    
                    // Process and display the articles
                    filterArticlesByRegion(currentRegion);
                    
                    // Hide loading indicator
                    loadingElement.classList.add('hidden');
                    
                    // Success!
                    return true;
                }
                
                // If all methods failed, show error
                loadingElement.classList.add('hidden');
                throw new Error('Could not fetch articles from API or cache');
            } catch (error) {
                handleApiError(error);
                return false;
            }
        }

        // Simple error handling function
        function handleApiError(error) {
            console.error('Error fetching articles:', error);
            loadingElement.classList.add('hidden');
            statusElement.textContent = 'Error loading articles';
            contentArea.innerHTML = `
                <div class="col-span-full text-center py-8">
                <p class="text-red-600 mb-4">Error: ${error.message || 'Failed to fetch data'}. Please try again later.</p>
                <div class="flex justify-center gap-4">
                    <button id="retry-btn" class="bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600 transition-colors">
                    <i class="fas fa-sync mr-2"></i>Retry
                    </button>
                    <button id="use-demo-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-newspaper mr-2"></i>Use Demo Data
                    </button>
                </div>
                </div>
            `;
            
            document.getElementById('retry-btn').addEventListener('click', function() {
                fetchArticles(true);
            });
            
            document.getElementById('use-demo-btn').addEventListener('click', function() {
                useDemoData();
            });
        }

        // Function to use demo data when API is completely unavailable
        function useDemoData() {
            statusElement.textContent = 'Using demo data';
            
            // Create sample demo data (simplified version with just a few articles)
            const demoData = {
                success: true,
                timestamp: new Date().toISOString(),
                count: 3,
                articles: [
                {
                    title: "Sample Article: Tennessee Tourism Reaches Record Numbers",
                    link: "#demo-article-1",
                    description: "Tourism in Tennessee has reached an all-time high according to new data released by the state's Department of Tourist Development.",
                    pubDate: new Date().toISOString(),
                    source: "Demo Source",
                    region: "Nashville",
                    category: "Business",
                    image: "https://via.placeholder.com/400x300?text=Tennessee+Tourism"
                },
                {
                    title: "Sample Article: New Infrastructure Project Announced",
                    link: "#demo-article-2",
                    description: "State officials announced a major infrastructure project that will improve transportation across middle Tennessee.",
                    pubDate: new Date().toISOString(),
                    source: "Demo Source",
                    region: "Nashville",
                    category: "Development",
                    image: "https://via.placeholder.com/400x300?text=Infrastructure+Project"
                },
                {
                    title: "Sample Article: Local Festival Returns This Summer",
                    link: "#demo-article-3",
                    description: "The popular summer festival will return with expanded programming and new attractions for all ages.",
                    pubDate: new Date().toISOString(),
                    source: "Demo Source",
                    region: "Knoxville",
                    category: "Arts & Culture",
                    image: "https://via.placeholder.com/400x300?text=Summer+Festival"
                }
                ]
            };
            
            // Process the demo data
            allArticles = demoData.articles;
            filteredArticles = [...allArticles];
            
            // Make articles available for search
            window.allArticles = allArticles;
            
            // Display the demo data
            statusElement.textContent = 'Showing demo content (API unavailable)';
            filterArticlesByRegion(currentRegion);
            
            // Hide loading indicator
            loadingElement.classList.add('hidden');
        }

        function setupInteractions() {
            console.log('Starting setupInteractions');
            // Handle article link clicks
            document.addEventListener('click', function(event) {
                const articleLink = event.target.closest('.article-link');
                if (articleLink && !event.target.closest('.comment-btn, .like-btn, .dislike-btn, .share-btn, .favorite-btn')) {
                    // If it's a real link (not "#"), allow the browser to handle it
                    if (articleLink.getAttribute('href') && articleLink.getAttribute('href') !== '#') {
                        // This is intentionally left without preventDefault() to allow normal navigation
                        console.log('User clicked article link: ', articleLink.getAttribute('href'));
                    }
                }
            });
            // Load initial reactions for each article
            console.log('Setting up reactions for articles');
            document.querySelectorAll('[data-article-id]').forEach(async article => {
                const articleId = article.dataset.articleId;
                
                if (window.UserTracking) {
                    // Use the UserTracking system to get reaction counts
                    const counts = await window.UserTracking.getReactionCounts(articleId);
                    
                    const likeCount = article.querySelector('.like-count');
                    const dislikeCount = article.querySelector('.dislike-count');
                    
                    if (likeCount) likeCount.textContent = counts.likes;
                    if (dislikeCount) dislikeCount.textContent = counts.dislikes;
                } else {
                    // Fallback to localStorage if UserTracking isn't available
                    const reactions = getArticleReactions(articleId);
                    const likeCount = article.querySelector('.like-count');
                    const dislikeCount = article.querySelector('.dislike-count');
                    if (likeCount) likeCount.textContent = reactions.likes;
                    if (dislikeCount) dislikeCount.textContent = reactions.dislikes;
                }
            });

            // Setup reaction tracking (likes/dislikes) with article metadata
            document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const articleId = this.dataset.articleId;
                    const action = this.dataset.action;
                    
                    // Find the article container to get metadata
                    const articleContainer = this.closest('.bg-white');
                    if (!articleContainer) {
                        console.error('Could not find article container');
                        return;
                    }
                    
                    // Extract article metadata for article creation if needed
                    const titleElement = articleContainer.querySelector('h3 a');
                    const title = titleElement ? titleElement.textContent.trim() : '';
                    const link = titleElement && titleElement.hasAttribute('href') ? titleElement.getAttribute('href') : '';
                    const sourceElement = articleContainer.querySelector('.text-sm.text-neutral-500');
                    const source = sourceElement ? sourceElement.textContent.trim() : '';
                    
                    // Visual feedback - add loading state
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    if (window.UserTracking) {
                        // Use UserTracking to track reaction with article metadata
                        const result = await window.UserTracking.trackReaction(articleId, action, {
                            title: title,
                            source: source,
                            url: link
                        });
                        
                        // Restore button
                        this.innerHTML = originalHTML;
                        
                        if (result) {
                            // Find the article card that contains this button
                            const articleCard = this.closest('[data-article-id]');
                            
                            if (articleCard) {
                                // Find count elements within this specific article card
                                const likeCount = articleCard.querySelector('.like-count');
                                const dislikeCount = articleCard.querySelector('.dislike-count');
                                
                                console.log('Updating counts:', {
                                    articleId,
                                    likes: result.likes,
                                    dislikes: result.dislikes,
                                    likeCountElement: likeCount,
                                    dislikeCountElement: dislikeCount
                                });
                                
                                // Update counts
                                if (likeCount) likeCount.textContent = result.likes;
                                if (dislikeCount) dislikeCount.textContent = result.dislikes;
                                
                                // Visual feedback based on action
                                if (result.action === 'removed') {
                                    this.classList.remove('text-blue-500');
                                } else {
                                    // Highlight this button
                                    this.classList.add('text-blue-500');
                                    
                                    // If updated, un-highlight the other button
                                    if (result.action === 'updated') {
                                        const otherAction = action === 'like' ? 'dislike' : 'like';
                                        const otherButton = articleCard.querySelector(`[data-action="${otherAction}"]`);
                                        if (otherButton) {
                                            otherButton.classList.remove('text-blue-500');
                                        }
                                    }
                                }
                            }
                        } else {
                            console.error('Reaction failed for:', articleId, action);
                        }
                    } else {
                        // Fallback to simple localStorage if UserTracking isn't available
                        this.innerHTML = originalHTML; // Restore button
                        
                        const article = document.querySelector(`[data-article-id="${articleId}"]`);
                        if (!article) return;
                        
                        const reactions = getArticleReactions(articleId);
                        if (action === 'like') {
                            reactions.likes += 1;
                        } else if (action === 'dislike') {
                            reactions.dislikes += 1;
                        }
                        
                        saveArticleReactions(articleId, reactions);
                        
                        const likeCount = article.querySelector('.like-count');
                        const dislikeCount = article.querySelector('.dislike-count');
                        
                        if (likeCount) likeCount.textContent = reactions.likes;
                        if (dislikeCount) dislikeCount.textContent = reactions.dislikes;
                        
                        this.classList.add('text-blue-500');
                        setTimeout(() => {
                            this.classList.remove('text-blue-500');
                        }, 500);
                    }
                });
            });

            // Share buttons
            document.querySelectorAll('.share-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    // Get article data
                    const articleContainer = this.closest('.bg-white');
                    const articleLink = articleContainer.querySelector('.article-link');
        
                    if (!articleLink) {
                        console.error('Article link element not found');
                        return;
                     }
                    const titleElement = articleContainer.querySelector('h3 a');
                    const title = titleElement ? titleElement.textContent.trim() : 'Tennessee News Article';
                    const link = titleElement && titleElement.hasAttribute('href') ? titleElement.getAttribute('href') : '';
                            // Check if the link is valid
                    if (!link || link === '#') {
                        console.error('Invalid article link:', link);
                        alert('Sorry, no valid article link found to share.');
                        return;
                    }
                    const descriptionElement = articleContainer.querySelector('p.text-neutral-600');
                    const description = descriptionElement ? descriptionElement.textContent.trim() : '';
                    const sourceElement = articleContainer.querySelector('.text-sm.text-neutral-500');
                    const source = sourceElement ? sourceElement.textContent.trim() : '';
                    const imageElement = articleContainer.querySelector('img');
                    const imageUrl = imageElement ? imageElement.getAttribute('src') : '';
                    
                    console.log('Share data found:', {
                        title, 
                        source,
                        description: description.substring(0, 30) + '...',
                        link
                    });
                    
                    // Loading state
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    try {
                        // Direct API call to track-share
                        const apiUrl = 'https://tennesseefeeds-api.onrender.com/api/track-share';
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                articleId: link,
                                title: title,
                                description: description,
                                source: source,
                                url: link,
                                image: imageUrl,
                                platform: 'web'
                            })
                        });
                        
                        const data = await response.json();
                        
                        // Restore button
                        this.innerHTML = '<i class="fas fa-share"></i>';
                        
                        if (data.success && data.shareUrl) {
                            createOrShowShareModal(data.shareUrl, title);
                        } else {
                            alert('Sorry, there was an error creating the share link.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.innerHTML = '<i class="fas fa-share"></i>';
                        alert('Sorry, there was an error creating the share link.');
                    }
                });
            });

            // Comment buttons (using UserTracking if available)
            console.log('Setting up post-comment buttons');
            document.addEventListener('click', async function(event) {
                const postButton = event.target.closest('.post-comment-btn');
                if (!postButton) return;

                console.log('Post comment button clicked:', postButton);
                event.preventDefault();
                event.stopPropagation();

                const articleCard = postButton.closest('[data-article-id]');
                const articleId = articleCard.dataset.articleId;
                const commentInput = articleCard.querySelector('.comment-input');
                const articleTitle = articleCard.querySelector('h3 a')?.textContent || 'Untitled Article';
                const articleSource = articleCard.dataset.source || 'Unknown';
                const articleUrl = articleCard.querySelector('a')?.href || '';
                const commentText = commentInput.value.trim();
                
                if (commentText === '') {
                    alert('Please enter a comment');
                    return;
                }
                
                let success = false;
                
                // Try to use UserTracking for comment tracking
                if (window.UserTracking) {
                    success = await window.UserTracking.trackComment(articleId, commentText);
                } else {
                    // Fallback to original comment function
                    let username = localStorage.getItem('tnfeeds_username');
                    if (!username) {
                        username = prompt('Enter your name (or remain Anonymous):', 'Anonymous') || 'Anonymous';
                        localStorage.setItem('tnfeeds_username', username);
                    }
                    
                    success = await window.postComment(
                        null, articleId, username, commentText, articleTitle, articleSource, articleUrl
                    );
                }
                
                if (success) {
                    commentInput.value = '';
                    window.loadComments(articleId);
                } else {
                    alert('Error posting comment. Please try again.');
                }
            });

            // Prevent article links from interfering with comment buttons
            console.log('Setting up article link protection');
            document.addEventListener('click', function(event) {
                const link = event.target.closest('h3 a[href]');
                if (link) {
                    console.log('Article link click detected:', event.target, 'closest link:', link);
                    const commentBtn = event.target.closest('.comment-btn');
                    if (commentBtn) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        console.log('Prevented article link navigation from comment button click:', event.target);
                    }
                }
            });

            console.log('Finished setupInteractions');
        }

        // Local storage for article reactions (fallback if UserTracking unavailable)
        function getArticleReactions(articleId) {
            const reactions = localStorage.getItem(`reactions_${articleId}`);
            return reactions ? JSON.parse(reactions) : { likes: 0, dislikes: 0 };
        }

        function saveArticleReactions(articleId, reactions) {
            localStorage.setItem(`reactions_${articleId}`, JSON.stringify(reactions));
        }

        // Function to create or show the share modal
        function createOrShowShareModal(shareUrl, title) {
            let shareModal = document.getElementById('share-modal');
            if (!shareModal) {
                shareModal = document.createElement('div');
                shareModal.id = 'share-modal';
                shareModal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                shareModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Share Article</h3>
                            <button id="close-share-modal" class="text-neutral-500 hover:text-neutral-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="mb-4">
                            <input id="share-url" type="text" class="w-full px-3 py-2 border rounded-md" readonly>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mb-4">
                            <a href="#" id="share-facebook" class="share-social-btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <i class="fab fa-facebook-f mr-2"></i>Facebook
                            </a>
                            <a href="#" id="share-twitter" class="share-social-btn bg-blue-400 text-white px-4 py-2 rounded-md hover:bg-blue-500">
                                <i class="fab fa-twitter mr-2"></i>Twitter
                            </a>
                            <a href="#" id="share-linkedin" class="share-social-btn bg-blue-700 text-white px-4 py-2 rounded-md hover:bg-blue-800">
                                <i class="fab fa-linkedin-in mr-2"></i>LinkedIn
                            </a>
                            <a href="#" id="share-email" class="share-social-btn bg-neutral-600 text-white px-4 py-2 rounded-md hover:bg-neutral-700">
                                <i class="fas fa-envelope mr-2"></i>Email
                            </a>
                        </div>
                        <button id="copy-share-url" class="w-full bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600">
                            <i class="fas fa-copy mr-2"></i>Copy Link
                        </button>
                    </div>
                `;
                document.body.appendChild(shareModal);
                
                document.getElementById('close-share-modal').addEventListener('click', function() {
                    shareModal.classList.add('hidden');
                });
                
                document.getElementById('copy-share-url').addEventListener('click', function() {
                    const shareUrlInput = document.getElementById('share-url');
                    shareUrlInput.select();
                    document.execCommand('copy');
                    this.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-copy mr-2"></i>Copy Link';
                    }, 2000);
                });
                
                shareModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                    }
                });
            }
            
            setupSocialShareButtons(shareUrl, title);
            const shareUrlInput = document.getElementById('share-url');
            shareUrlInput.value = shareUrl;
            shareModal.classList.remove('hidden');
        }

        // Function to set up social share buttons
        function setupSocialShareButtons(shareUrl, title) {
            const facebookBtn = document.getElementById('share-facebook');
            facebookBtn.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
            facebookBtn.target = '_blank';
            facebookBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.open(this.href, 'facebook-share-dialog', 'width=800,height=600');
            });
            
            const twitterBtn = document.getElementById('share-twitter');
            twitterBtn.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(title + ' | TennesseeFeeds')}`;
            twitterBtn.target = '_blank';
            twitterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.open(this.href, 'twitter-share-dialog', 'width=800,height=600');
            });
            
            const linkedinBtn = document.getElementById('share-linkedin');
            linkedinBtn.href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;
            linkedinBtn.target = '_blank';
            linkedinBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.open(this.href, 'linkedin-share-dialog', 'width=800,height=600');
            });
            
            const emailBtn = document.getElementById('share-email');
            emailBtn.href = `mailto:?subject=${encodeURIComponent(title + ' | TennesseeFeeds')}&body=${encodeURIComponent('Check out this article from TennesseeFeeds: ' + shareUrl)}`;
        }

        // Set up event listeners for region links
        document.querySelectorAll('.region-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const region = this.dataset.region;
                filterArticlesByRegion(region);
                
                // Close mobile menu if open
                if (mobileMenu && mobileMenu.classList.contains('show')) {
                    mobileMenu.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });
        
        // Add load more button functionality
        loadMoreBtn.addEventListener('click', function() {
            currentPage++;
            displayArticles();
        });
        
        // Add refresh button functionality
        refreshBtn.addEventListener('click', function() {
            fetchArticles(true);
        });
        
        // SEARCH FUNCTIONALITY
        function performSearch(query) {
            if (!query || query.trim() === '') {
                alert('Please enter a search term');
                return;
            }
            
            const searchOverlay = document.getElementById('search-overlay');
            const searchResults = document.getElementById('search-results');
            const searchTerm = document.getElementById('search-term');
            
            // Show search UI
            if (searchOverlay && searchResults) {
                searchOverlay.classList.remove('hidden');
                searchResults.innerHTML = `
                  <div class="text-center py-4">
                    <div class="inline-block animate-spin h-6 w-6 border-2 border-neutral-300 border-t-neutral-600 rounded-full"></div>
                    <p class="text-sm text-neutral-500 mt-2">Searching...</p>
                  </div>
                `;
                
                if (searchTerm) {
                    searchTerm.textContent = query;
                }
            }
            
            // Get articles from window.allArticles or localStorage
            let articlesToSearch = [];
            
            if (window.allArticles && Array.isArray(window.allArticles)) {
                articlesToSearch = window.allArticles;
            } else {
                try {
                    const cachedData = localStorage.getItem('tennesseefeeds_cache');
                    if (cachedData) {
                        const data = JSON.parse(cachedData);
                        if (data.articles && Array.isArray(data.articles)) {
                            articlesToSearch = data.articles;
                        }
                    }
                } catch (e) {
                    console.error('Error accessing cached articles:', e);
                }
            }
            
            if (articlesToSearch.length === 0) {
                if (searchResults) {
                    searchResults.innerHTML = `
                      <div class="text-center py-4">
                        <p class="text-neutral-600">No articles available for search. Please refresh the page.</p>
                      </div>
                    `;
                }
                return;
            }
            
            // Perform the actual search
            const queryLower = query.toLowerCase();
            const matchedArticles = articlesToSearch.filter(article => {
                const title = article.title ? article.title.toLowerCase() : '';
                const description = article.description ? article.description.toLowerCase() : '';
                const source = article.source ? article.source.toLowerCase() : '';
                
                return title.includes(queryLower) || 
                       description.includes(queryLower) || 
                       source.includes(queryLower);
            });
            
            // Display results
            if (searchResults) {
                if (matchedArticles.length === 0) {
                    searchResults.innerHTML = `
                      <div class="text-center py-8">
                        <p class="text-neutral-600">No articles found matching "${query}"</p>
                        <p class="text-sm text-neutral-500 mt-2">Try a different search term</p>
                      </div>
                    `;
                } else {
                    // Render matched articles
                    searchResults.innerHTML = `
                      <div class="mb-4 text-neutral-600">
                        Found ${matchedArticles.length} articles matching "${query}"
                      </div>
                      <div class="grid md:grid-cols-2 gap-4" id="search-results-grid"></div>
                    `;
                    
                    const resultsGrid = document.getElementById('search-results-grid');
                    
                    if (resultsGrid) {
                        // Render first 10 matches (or all if less than 10)
                        const articlesToShow = matchedArticles.slice(0, 10);
                        
                        articlesToShow.forEach(article => {
                            const articleElement = document.createElement('div');
                            articleElement.className = 'search-result-item bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow mb-4';
                            
                            const articleId = article.link.replace(/[^a-zA-Z0-9]/g, '-');
                            
                            // Format date
                            let formattedDate = '';
                            try {
                                const date = new Date(article.pubDate);
                                formattedDate = date.toLocaleDateString('en-US', {
                                  year: 'numeric',
                                  month: 'short',
                                  day: 'numeric'
                                });
                            } catch (e) {
                                formattedDate = article.pubDate || '';
                            }
                            
                            articleElement.innerHTML = `
                              <div class="p-4" data-article-id="${articleId}">
                                <div class="flex justify-between items-start mb-2">
                                  <span class="text-sm text-neutral-500">${article.source || 'Unknown Source'}</span>
                                  <span class="text-sm text-neutral-500">${formattedDate}</span>
                                </div>
                                <h3 class="text-lg font-bold text-neutral-800 mb-2">
                                  <a href="${article.link}" class="hover:text-neutral-600 transition-colors article-link" data-article-id="${articleId}">
                                    ${article.title}
                                  </a>
                                </h3>
                                <p class="text-neutral-600 text-sm line-clamp-2">${article.description || ''}</p>
                                <div class="mt-2 text-right">
                                  <a href="#" class="view-article text-sm text-blue-600 hover:text-blue-800" data-article-id="${articleId}">View article</a>
                                </div>
                              </div>
                            `;
                            
                            resultsGrid.appendChild(articleElement);
                        });
                        
                        // If we have more than 10 results, add a "Show more" button
                        if (matchedArticles.length > 10) {
                            const showMoreButton = document.createElement('div');
                            showMoreButton.className = 'col-span-full text-center mt-4';
                            showMoreButton.innerHTML = `
                              <button class="bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600 transition-colors" id="show-more-results">
                                Show More Results (${matchedArticles.length - 10} more)
                              </button>
                            `;
                            
                            resultsGrid.parentNode.appendChild(showMoreButton);
                            
                            // Add show more functionality
                            document.getElementById('show-more-results').addEventListener('click', function() {
                                // Remove the button
                                this.parentNode.remove();
                                
                                // Add the next batch of results
                                const nextBatch = matchedArticles.slice(10, 30);
                                
                                nextBatch.forEach(article => {
                                    const articleElement = document.createElement('div');
                                    articleElement.className = 'search-result-item bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow mb-4';
                                    
                                    const articleId = article.link.replace(/[^a-zA-Z0-9]/g, '-');
                                    
                                    let formattedDate = '';
                                    try {
                                        const date = new Date(article.pubDate);
                                        formattedDate = date.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        });
                                    } catch (e) {
                                        formattedDate = article.pubDate || '';
                                    }
                                    
                                    articleElement.innerHTML = `
                                      <div class="p-4" data-article-id="${articleId}">
                                        <div class="flex justify-between items-start mb-2">
                                          <span class="text-sm text-neutral-500">${article.source || 'Unknown Source'}</span>
                                          <span class="text-sm text-neutral-500">${formattedDate}</span>
                                        </div>
                                        <h3 class="text-lg font-bold text-neutral-800 mb-2">
                                          <a href="${article.link}" class="hover:text-neutral-600 transition-colors article-link" data-article-id="${articleId}">
                                            ${article.title}
                                          </a>
                                        </h3>
                                        <p class="text-neutral-600 text-sm line-clamp-2">${article.description || ''}</p>
                                        <div class="mt-2 text-right">
                                          <a href="#" class="view-article text-sm text-blue-600 hover:text-blue-800" data-article-id="${articleId}">View article</a>
                                        </div>
                                      </div>
                                    `;
                                    
                                    resultsGrid.appendChild(articleElement);
                                });
                                
                                // If there are still more results, add another show more button
                                if (matchedArticles.length > 30) {
                                    const showEvenMoreButton = document.createElement('div');
                                    showEvenMoreButton.className = 'col-span-full text-center mt-4';
                                    showEvenMoreButton.innerHTML = `
                                      <button class="bg-neutral-700 text-white px-4 py-2 rounded-md hover:bg-neutral-600 transition-colors" id="show-even-more-results">
                                        Show All Results (${matchedArticles.length - 30} more)
                                      </button>
                                    `;
                                    
                                    resultsGrid.parentNode.appendChild(showEvenMoreButton);
                                    
                                    // Add functionality for the second "show more" button
                                    document.getElementById('show-even-more-results').addEventListener('click', function() {
                                        // Remove the button
                                        this.parentNode.remove();
                                        
                                        // Add all remaining results
                                        const remainingResults = matchedArticles.slice(30);
                                        
                                        remainingResults.forEach(article => {
                                            const articleElement = document.createElement('div');
                                            articleElement.className = 'search-result-item bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow mb-4';
                                            
                                            const articleId = article.link.replace(/[^a-zA-Z0-9]/g, '-');
                                            
                                            let formattedDate = '';
                                            try {
                                                const date = new Date(article.pubDate);
                                                formattedDate = date.toLocaleDateString('en-US', {
                                                    year: 'numeric',
                                                    month: 'short',
                                                    day: 'numeric'
                                                });
                                            } catch (e) {
                                                formattedDate = article.pubDate || '';
                                            }
                                            
                                            articleElement.innerHTML = `
                                              <div class="p-4" data-article-id="${articleId}">
                                                <div class="flex justify-between items-start mb-2">
                                                  <span class="text-sm text-neutral-500">${article.source || 'Unknown Source'}</span>
                                                  <span class="text-sm text-neutral-500">${formattedDate}</span>
                                                </div>
                                                <h3 class="text-lg font-bold text-neutral-800 mb-2">
                                                  <a href="${article.link}" class="hover:text-neutral-600 transition-colors article-link" data-article-id="${articleId}">
                                                    ${article.title}
                                                  </a>
                                                </h3>
                                                <p class="text-neutral-600 text-sm line-clamp-2">${article.description || ''}</p>
                                                <div class="mt-2 text-right">
                                                  <a href="#" class="view-article text-sm text-blue-600 hover:text-blue-800" data-article-id="${articleId}">View article</a>
                                                </div>
                                              </div>
                                            `;
                                            
                                            resultsGrid.appendChild(articleElement);
                                        });
                                    });
                                }
                            });
                        }
                        
                        // Add event listeners to the view article links
                        document.querySelectorAll('.view-article').forEach(link => {
                            link.addEventListener('click', async function(e) {
                                e.preventDefault();
                                
                                const articleId = this.dataset.articleId;
                                if (articleId) {
                                    // If article system is available, use it to display article
                                    if (window.ArticleSystem && window.ArticleSystem.fetchArticleById) {
                                        const article = await window.ArticleSystem.fetchArticleById(articleId);
                                        
                                        if (article && window.ArticleSystem.showArticleView) {
                                            window.ArticleSystem.showArticleView(article);
                                            
                                            // Close the search overlay
                                            if (searchOverlay) {
                                                searchOverlay.classList.add('hidden');
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    }
                }
            }
        }
        
        // Set up search input event listeners
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const mobileSearchInput = document.getElementById('mobile-search-input');
        const mobileSearchButton = document.getElementById('mobile-search-button');
        const closeSearchButton = document.getElementById('close-search-button');
        const searchOverlay = document.getElementById('search-overlay');
        
        if (searchButton && searchInput) {
            searchButton.addEventListener('click', () => {
                performSearch(searchInput.value);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(searchInput.value);
                }
            });
        }
        
        if (mobileSearchButton && mobileSearchInput) {
            mobileSearchButton.addEventListener('click', () => {
                performSearch(mobileSearchInput.value);
                
                // Close mobile menu after search
                if (mobileMenu) {
                    mobileMenu.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
            
            mobileSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(mobileSearchInput.value);
                    
                    // Close mobile menu after search
                    if (mobileMenu) {
                        mobileMenu.classList.remove('show');
                        document.body.style.overflow = '';
                    }
                }
            });
        }
        
        if (closeSearchButton && searchOverlay) {
            closeSearchButton.addEventListener('click', () => {
                searchOverlay.classList.add('hidden');
            });
            
            searchOverlay.addEventListener('click', (e) => {
                if (e.target === searchOverlay) {
                    searchOverlay.classList.add('hidden');
                }
            });
        }
        
        // Initial setup
        document.querySelector('.region-link[data-region="all"]').classList.add('bg-neutral-700');
        filteredArticles = allArticles;
        fetchArticles();
    }
});

// Debug: Log all click events
document.addEventListener('click', function(event) {
    console.log('Global click event:', event.target);
});

// Username change functionality - fixed to prevent double prompts
window.updateUsername = async function() {
    // Check if we're already in the middle of updating username
    if (window._isUpdatingUsername) {
        console.log('Username update already in progress');
        return false;
    }
    
    // Set flag to prevent double execution
    window._isUpdatingUsername = true;
    
    // Clear the flag after 2 seconds no matter what happens
    setTimeout(() => {
        window._isUpdatingUsername = false;
    }, 2000);
    
    let newUsername = prompt('Enter a new username:', '');
    
    // If user cancels or enters empty string, abort
    if (newUsername === null || newUsername.trim() === '') {
        window._isUpdatingUsername = false;
        return false;
    }
    
    // Trim and sanitize username
    newUsername = newUsername.trim().substring(0, 30);
    
    // If UserTracking is available, use it
    if (window.UserTracking && window.UserTracking.updateUsername) {
        try {
        const success = await window.UserTracking.updateUsername(newUsername);
        if (success) {
            console.log('Username updated successfully to:', newUsername);
            
            // Update display immediately
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) {
            usernameDisplay.textContent = newUsername;
            }
            
            window._isUpdatingUsername = false;
            return true;
        } else {
            console.error('Failed to update username via API');
        }
        } catch (error) {
        console.error('Error updating username:', error);
        }
    }
    
    // Fallback: Just update localStorage
    localStorage.setItem('tnfeeds_username', newUsername);
    console.log('Username updated locally to:', newUsername);
    
    // Update display
    const usernameDisplay = document.getElementById('username-display');
    if (usernameDisplay) {
        usernameDisplay.textContent = newUsername;
    }
    
    // Also update the user profile section visibility
    const userProfile = document.getElementById('user-profile');
    if (userProfile) {
        userProfile.classList.remove('hidden');
    }
    
    window._isUpdatingUsername = false;
    return true;
};

// Ensure we only add one event listener to the change button
document.addEventListener('DOMContentLoaded', function() {
    const changeUsernameBtn = document.getElementById('change-username-btn');
    if (changeUsernameBtn) {
        console.log('Setting up username change button');
        
        // Mark the button to track if we've already set up the listener
        if (changeUsernameBtn.dataset.listenerAdded) {
        console.log('Listener already added to change button, skipping');
        return;
        }
        
        // Remove any existing event listeners (clone the element)
        const newButton = changeUsernameBtn.cloneNode(true);
        changeUsernameBtn.parentNode.replaceChild(newButton, changeUsernameBtn);
        
        // Add our listener to the new button
        newButton.addEventListener('click', function(e) {
        console.log('Change username button clicked!');
        e.preventDefault();
        e.stopPropagation();
        window.updateUsername();
        });
        
        // Mark the button so we know it has a listener
        newButton.dataset.listenerAdded = 'true';
    } else {
        console.error('Change username button not found in DOM');
    }
    
    // Initialize username display from localStorage
    const usernameDisplay = document.getElementById('username-display');
    if (usernameDisplay) {
        const storedUsername = localStorage.getItem('tnfeeds_username') || 'Anonymous';
        usernameDisplay.textContent = storedUsername;
        
        // Also show the user profile section
        const userProfile = document.getElementById('user-profile');
        if (userProfile) {
        userProfile.classList.remove('hidden');
        }
    }
});
</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-614P6J1FFX"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-614P6J1FFX');
</script>
<!-- AdSense script -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4301346862997799" crossorigin="anonymous"></script>
<!-- Auto Ads code -->
<script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4301346862997799",
        enable_page_level_ads: true
    });
</script>
<script src="comments.js"></script>
<script src="button-fix-script.js"></script>
<script src="modified-trending-contributors.js"></script>
<script src="comment-handlers.js"></script>
<script src="share-handlers.js"></script>
<script src="article-system.js"></script>
<script src="search.js"></script>
</body>
</html>
